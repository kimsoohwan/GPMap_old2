#if 1

// STL
#include <string>
#include <vector>
#include <sstream>
#include <algorithm>

// GPMap
#include "io/io.hpp"								// loadPointCloud, savePointCloud, loadSensorPositionList
#include "visualization/cloud_viewer.hpp"	// show
#include "octomap/octomap.hpp"				// OctoMap
using namespace GPMap;

int main(int argc, char** argv)
{
	// [0] setting - directory
	const std::string strInputDataFolder			("../../data/bunny/input/");
	const std::string strIntermediateDataFolder	("../../data/bunny/intermediate/");
	const std::string strOctomapOutputDataFolder	("../../data/bunny/output/octomap/");
	create_directory(strOctomapOutputDataFolder);

	// [0] setting - observations
	const size_t NUM_OBSERVATIONS = 4; 
	const std::string strObsFileNames_[]	= {"bun000", "bun090", "bun180", "bun270"};
	StringList strObsFileNames(strObsFileNames_, strObsFileNames_ + NUM_OBSERVATIONS); 

	// [1] load data
	std::cout << "[Input Data]" << std::endl;
	int fOctreeDownSampling;
	std::cout << "No sampling(-1), Random sampling(0) or octree-based down sampling(1)?";
	std::cin >> fOctreeDownSampling;

	float param;
	std::string strDownSampledIntermediateDataFolder;
	std::string strDownSampledOctomapOutputDataFolder;
	if(fOctreeDownSampling > 0)
	{
		// leaf size
		std::cout << "Down sampling leaf size: ";
		std::cin >> param; // 0.001(50%), 0.002(20%), 0.003(10%)

		// sub folder
		std::stringstream ss;
		ss << "down_sampling_" << param << "/";
		strDownSampledIntermediateDataFolder	= strIntermediateDataFolder	+ ss.str();
		strDownSampledOctomapOutputDataFolder	= strOctomapOutputDataFolder	+ ss.str();
	}
	else if(fOctreeDownSampling < 0)
	{
		strDownSampledIntermediateDataFolder	= strIntermediateDataFolder	+ "original/";
		strDownSampledOctomapOutputDataFolder	= strOctomapOutputDataFolder	+ "original/";
	}
	else
	{
		// sampling ratio
		std::cout << "Random sampling ratio: ";
		std::cin >> param;	// 0.5, 0.3, 0.2, 0.1

		// sub folder
		std::stringstream ss;
		ss << "random_sampling_" << param << "/";
		strDownSampledIntermediateDataFolder	= strIntermediateDataFolder	+ ss.str();
		strDownSampledOctomapOutputDataFolder	= strOctomapOutputDataFolder	+ ss.str();
	}
	create_directory(strDownSampledOctomapOutputDataFolder);

	// [1-1] load original/down-sampled hit points
	const std::string strOriginalIntermediateDataFolder = strIntermediateDataFolder + "original/";
	PointXYZCloudPtrList hitPointCloudPtrList;
	loadPointCloud<pcl::PointXYZ>(hitPointCloudPtrList, strObsFileNames, strOriginalIntermediateDataFolder, ".pcd");

	PointXYZCloudPtrList sampledHitPointCloudPtrList;
	loadPointCloud<pcl::PointXYZ>(sampledHitPointCloudPtrList, strObsFileNames, strDownSampledIntermediateDataFolder, ".pcd");

	// [1-2] load sensor positions
	PointXYZVList sensorPositionList;
	loadSensorPositionList(sensorPositionList, strObsFileNames, strInputDataFolder, "_camera_position.txt");
	assert(NUM_OBSERVATIONS == hitPointCloudPtrList.size() && NUM_OBSERVATIONS == sensorPositionList.size());

	// [2] Octomaps

	// resolution
	double	RESOLUTION = 0.001;
	std::cout << "Resolution: ";
	std::cin >> RESOLUTION;

	// sub folders
	std::stringstream ss;
	ss << "resolution_" << RESOLUTION << "/";
	const std::string strMyOctomapOutputDataFolder	(strDownSampledOctomapOutputDataFolder + ss.str());
	const std::string strLogFolder						(strMyOctomapOutputDataFolder + "log/");
	create_directory(strMyOctomapOutputDataFolder);
	create_directory(strLogFolder);

	// log file
	LogFile logFile(strLogFolder + "octomap.log");
		
	// setting
	OctoMap<NO_COLOR> octomap(RESOLUTION);

	// update
	CPU_Times octomap_elapsed, octomap_total_elapsed;
	octomap_total_elapsed.clear();
	for(size_t i = 0; i < sampledHitPointCloudPtrList.size(); i++)
	{
		logFile << "==== Updating the OctoMap with the point cloud #" << i << " ====" << std::endl;

		// update
		octomap_elapsed = octomap.update<pcl::PointXYZ, pcl::PointXYZ>(*(sampledHitPointCloudPtrList[i]), sensorPositionList[i]);

		// save
		std::stringstream ss;
		ss << strMyOctomapOutputDataFolder << "octomap_bunny_upto_" << i;
		octomap.save(ss.str());

		// accumulate cpu times
		octomap_total_elapsed += octomap_elapsed;
		logFile << octomap_elapsed << std::endl << std::endl;
	}

	// total time
	logFile << "============= Total Time =============" << std::endl;
	logFile << octomap_total_elapsed << std::endl << std::endl;

	// [4] evaluation
	logFile << "============= Evaluation =============" << std::endl;
	unsigned int num_points, num_voxels_correct, num_voxels_wrong, num_voxels_unknown;
	octomap.evaluate<pcl::PointXYZ, pcl::PointXYZ>(hitPointCloudPtrList, sensorPositionList,
																	num_points, num_voxels_correct, num_voxels_wrong, num_voxels_unknown);
	logFile << "Number of hit points: " << num_points << std::endl;
	logFile << "Number of correct voxels: " << num_voxels_correct << std::endl;
	logFile << "Number of wrong voxels: " << num_voxels_wrong << std::endl;
	logFile << "Number of unknown voxels: " << num_voxels_unknown << std::endl;
	logFile << "Correct rate (correct/(correct+wrong)): " << static_cast<float>(num_voxels_correct)/static_cast<float>(num_voxels_correct + num_voxels_wrong) << std::endl;

	system("pause");
}

#endif